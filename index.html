<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>المدير المالي الشخصي</title>

<style>
body{font-family:Tajawal,Arial;background:#f4f6f8;margin:0}
header{background:#1e88e5;color:#fff;padding:15px;text-align:center;font-size:22px}
.nav{display:flex}
.nav button{flex:1;padding:12px;border:none;background:#1565c0;color:#fff;font-size:16px}
.nav button.active{background:#1e88e5}
.container{max-width:1000px;margin:auto;padding:15px}
.card{background:#fff;border-radius:12px;padding:15px;margin-bottom:15px;box-shadow:0 2px 8px rgba(0,0,0,.08)}
input,select,button{width:100%;padding:10px;margin-top:8px;border-radius:8px;border:1px solid #ccc;font-size:16px}
button{background:#1e88e5;color:#fff;border:none;cursor:pointer}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{border-bottom:1px solid #ddd;padding:8px;text-align:center}
th{background:#f5f5f5}
.summary{display:flex;gap:10px;flex-wrap:wrap}
.box{flex:1;background:#e3f2fd;padding:10px;border-radius:10px;text-align:center}
.income{color:#2e7d32;font-weight:bold}
.expense{color:#c62828;font-weight:bold}
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
</head>

<body>

<header>المدير المالي الشخصي</header>

<div class="nav">
  <button id="financeBtn" class="active" onclick="showSection('finance')">العمليات</button>
  <button id="debtBtn" onclick="showSection('debts')">الديون</button>
</div>

<div class="container">

<!-- العمليات -->
<div id="finance">
<div class="card">
<select id="type">
<option value="income">دخل</option>
<option value="expense">مصروف</option>
</select>

<select id="category">
<option>راتب</option><option>إيجار</option><option>طعام</option>
<option>مواصلات</option><option>تسوق</option><option>بيع</option>
</select>

<input id="desc" placeholder="الوصف">
<input id="amount" type="number" placeholder="المبلغ">
<button id="addBtn" onclick="addTransaction()">إضافة</button>
</div>

<!-- إيقاف مؤقت -->
<div class="card">
<input id="pauseTime" type="number" placeholder="مدة التوقف بالثواني">
<button onclick="pauseOperations()">إيقاف العمليات مؤقتًا</button>
</div>

<!-- تصفية شهرية -->
<div class="card">
<select id="filterMonth" onchange="renderTransactions()">
<option value="">كل الشهور</option>
</select>
<select id="filterYear" onchange="renderTransactions()">
<option value="">كل السنوات</option>
</select>
</div>

<div class="card">
<table>
<thead>
<tr>
<th>النوع</th><th>الفئة</th><th>الوصف</th><th>المبلغ</th><th>التاريخ</th>
</tr>
</thead>
<tbody id="list"></tbody>
</table>
</div>

<div class="summary">
<div class="box income">الدخل<br><span id="totalIncome">0</span></div>
<div class="box expense">المصروف<br><span id="totalExpense">0</span></div>
<div class="box">الرصيد<br><span id="balance">0</span></div>
</div>

<button onclick="exportFinancePDF()">تصدير PDF</button>
</div>

<!-- الديون -->
<div id="debts" style="display:none">
<div class="card">
<input id="debtor" placeholder="الاسم">
<input id="debtAmount" type="number" placeholder="المبلغ">
<select id="debtType">
<option value="owedToYou">مدين لك</option>
<option value="youOwe">أنت مدين</option>
</select>
<button onclick="addDebt()">إضافة دين</button>
</div>

<div class="card">
<table>
<thead><tr><th>الاسم</th><th>المبلغ</th><th>النوع</th><th>التاريخ</th></tr></thead>
<tbody id="debtList"></tbody>
</table>
</div>

<button onclick="exportDebtPDF()">تصدير PDF</button>
</div>

</div>

<script>
let transactions = JSON.parse(localStorage.getItem('financeData')) || [];
let debts = JSON.parse(localStorage.getItem('debtData')) || [];

function showSection(s){
finance.style.display = s==='finance'?'block':'none';
debts.style.display = s==='debts'?'block':'none';
financeBtn.classList.toggle('active',s==='finance');
debtBtn.classList.toggle('active',s==='debts');
}

function addTransaction(){
const t=type.value,c=category.value,d=desc.value,a=+amount.value;
if(!d||a<=0)return;
const date=new Date();
transactions.push({
type:t,category:c,desc:d,amount:a,
date:date.toLocaleDateString('ar-EG'),
month:date.getMonth()+1,
year:date.getFullYear()
});
localStorage.setItem('financeData',JSON.stringify(transactions));
desc.value='';amount.value='';
updateFilters();renderTransactions();
}

function updateFilters(){
filterMonth.innerHTML='<option value="">كل الشهور</option>';
filterYear.innerHTML='<option value="">كل السنوات</option>';
[...new Set(transactions.map(t=>t.month))].forEach(m=>{
filterMonth.innerHTML+=`<option value="${m}">${m}</option>`;
});
[...new Set(transactions.map(t=>t.year))].forEach(y=>{
filterYear.innerHTML+=`<option value="${y}">${y}</option>`;
});
}

function renderTransactions(){
list.innerHTML='';
let inc=0,exp=0;
const m=filterMonth.value,y=filterYear.value;
transactions.filter(t=>(!m||t.month==m)&&(!y||t.year==y))
.forEach(t=>{
list.innerHTML+=`<tr>
<td>${t.type==='income'?'دخل':'مصروف'}</td>
<td>${t.category}</td>
<td>${t.desc}</td>
<td>${t.amount}</td>
<td>${t.date}</td></tr>`;
t.type==='income'?inc+=t.amount:exp+=t.amount;
});
totalIncome.textContent=inc;
totalExpense.textContent=exp;
balance.textContent=inc-exp;
}

function pauseOperations(){
let s=+pauseTime.value;if(s<=0)return;
addBtn.disabled=true;
let i=setInterval(()=>{
addBtn.textContent=`متوقف ${s--}`;
if(s<0){clearInterval(i);addBtn.disabled=false;addBtn.textContent='إضافة';}
},1000);
}

/* ===== PDF عربي ===== */
async function loadFont(doc){
const r=await fetch('NotoNaskhArabic-Regular.ttf');
const b=await r.arrayBuffer();
const f=btoa(String.fromCharCode(...new Uint8Array(b)));
doc.addFileToVFS('arab.ttf',f);
doc.addFont('arab.ttf','arab','normal');
doc.setFont('arab');
}

async function exportFinancePDF(){
const {jsPDF}=window.jspdf;
const doc=new jsPDF();
await loadFont(doc);
doc.text('كشف العمليات المالية',200,15,{align:'right'});
doc.autoTable({
startY:25,
head:[['التاريخ','النوع','الفئة','الوصف','المبلغ']],
body:transactions.map(t=>[t.date,t.type==='income'?'دخل':'مصروف',t.category,t.desc,t.amount]),
styles:{font:'arab',halign:'right'}
});
doc.save('العمليات.pdf');
}

async function exportDebtPDF(){
const {jsPDF}=window.jspdf;
const doc=new jsPDF();
await loadFont(doc);
doc.text('كشف الديون',200,15,{align:'right'});
doc.autoTable({
startY:25,
head:[['التاريخ','الاسم','النوع','المبلغ']],
body:debts.map(d=>[d.date,d.debtor,d.type==='owedToYou'?'مدين لك':'أنت مدين',d.amount]),
styles:{font:'arab',halign:'right'}
});
doc.save('الديون.pdf');
}

function addDebt(){
const n=debtor.value,a=+debtAmount.value,t=debtType.value;
if(!n||a<=0)return;
debts.push({debtor:n,amount:a,type:t,date:new Date().toLocaleDateString('ar-EG')});
localStorage.setItem('debtData',JSON.stringify(debts));
debtor.value='';debtAmount.value='';
renderDebts();
}

function renderDebts(){
debtList.innerHTML='';
debts.forEach(d=>{
debtList.innerHTML+=`<tr><td>${d.debtor}</td><td>${d.amount}</td><td>${d.type==='owedToYou'?'مدين لك':'أنت مدين'}</td><td>${d.date}</td></tr>`;
});
}

updateFilters();renderTransactions();renderDebts();
</script>
</body>
</html>
