<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>المدير المالي الشخصي</title>

<style>
body{font-family:Tajawal,Arial;background:#f4f6f8;margin:0}
header{background:#1e88e5;color:#fff;padding:15px;text-align:center;font-size:22px}
.nav{display:flex}
.nav button{flex:1;padding:12px;border:none;background:#1565c0;color:#fff;font-size:16px}
.nav button.active{background:#1e88e5}
.container{max-width:1100px;margin:auto;padding:15px}
.card{background:#fff;border-radius:12px;padding:15px;margin-bottom:15px;box-shadow:0 2px 8px rgba(0,0,0,.08)}
input,select,button{width:100%;padding:10px;margin-top:8px;border-radius:8px;border:1px solid #ccc;font-size:16px}
button{background:#1e88e5;color:#fff;border:none;cursor:pointer}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{border-bottom:1px solid #ddd;padding:8px;text-align:center}
th{background:#f5f5f5}
.summary{display:flex;gap:10px;flex-wrap:wrap}
.box{flex:1;background:#e3f2fd;padding:10px;border-radius:10px;text-align:center}
.income{color:#2e7d32;font-weight:bold}
.expense{color:#c62828;font-weight:bold}
.warning{background:#fff3e0}
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
</head>

<body>

<header>المدير المالي الشخصي</header>

<div class="nav">
<button id="financeBtn" class="active" onclick="showSection('finance')">العمليات</button>
<button id="debtBtn" onclick="showSection('debts')">الديون</button>
<button id="archiveBtn" onclick="showSection('archive')">الأرشيف</button>
</div>

<div class="container">

<!-- العمليات -->
<div id="finance">

<div class="card">
<select id="type">
<option value="income">دخل</option>
<option value="expense">مصروف</option>
</select>

<select id="category">
<option>راتب</option><option>إيجار</option><option>طعام</option>
<option>مواصلات</option><option>تسوق</option><option>فواتير</option>
</select>

<input id="desc" placeholder="الوصف">
<input id="amount" type="number" placeholder="المبلغ">
<button id="addBtn" onclick="addTransaction()">إضافة عملية</button>
</div>

<div class="card warning">
<h4>إغلاق الشهر</h4>
<p>سيتم ترحيل مصروفات الشهر الحالي إلى الأرشيف</p>
<button onclick="closeMonth()">تصفية وترحيل الشهر</button>
</div>

<div class="card">
<table>
<thead>
<tr><th>النوع</th><th>الفئة</th><th>الوصف</th><th>المبلغ</th><th>التاريخ</th></tr>
</thead>
<tbody id="transactionList"></tbody>
</table>
</div>

<div class="summary">
<div class="box income">الدخل<br><span id="totalIncome">0</span></div>
<div class="box expense">المصروف<br><span id="totalExpense">0</span></div>
<div class="box">الرصيد<br><span id="balance">0</span></div>
</div>

<button onclick="exportFinancePDF()">تصدير كشف الشهر PDF</button>
</div>

<!-- الديون -->
<div id="debts" style="display:none">

<div class="card">
<input id="debtor" placeholder="الاسم / الجهة">
<input id="debtAmount" type="number" placeholder="المبلغ">
<select id="debtType">
<option value="owedToYou">مدين لك</option>
<option value="youOwe">أنت مدين</option>
</select>
<button onclick="addDebt()">إضافة دين</button>
</div>

<div class="card">
<table>
<thead><tr><th>الاسم</th><th>المبلغ</th><th>النوع</th><th>التاريخ</th></tr></thead>
<tbody id="debtList"></tbody>
</table>
</div>

<button onclick="exportDebtPDF()">تصدير كشف الديون PDF</button>
</div>

<!-- الأرشيف -->
<div id="archive" style="display:none">

<div class="card">
<h4>الأشهر المؤرشفة</h4>
<select id="archiveSelect" onchange="renderArchive()">
<option value="">اختر شهر</option>
</select>
</div>

<div class="card">
<table>
<thead><tr><th>الفئة</th><th>الوصف</th><th>المبلغ</th><th>التاريخ</th></tr></thead>
<tbody id="archiveList"></tbody>
</table>
</div>

<button onclick="exportArchivePDF()">تصدير الشهر المؤرشف PDF</button>
<button onclick="clearArchive()">حذف الأرشيف بالكامل</button>
</div>

</div>

<script>
/* ===== المتغيرات ===== */
let transactions = JSON.parse(localStorage.getItem('financeData')) || [];
let debtData = JSON.parse(localStorage.getItem('debtData')) || [];
let archiveData = JSON.parse(localStorage.getItem('archiveData')) || [];

/* ===== التنقل ===== */
function showSection(s){
finance.style.display=s==='finance'?'block':'none';
debts.style.display=s==='debts'?'block':'none';
archive.style.display=s==='archive'?'block':'none';
financeBtn.classList.toggle('active',s==='finance');
debtBtn.classList.toggle('active',s==='debts');
archiveBtn.classList.toggle('active',s==='archive');
}

/* ===== العمليات ===== */
function addTransaction(){
if(!desc.value || amount.value<=0) return;
const d = new Date();
transactions.push({
type:type.value,
category:category.value,
desc:desc.value,
amount:+amount.value,
date:d.toLocaleDateString('ar-EG'),
month:d.getMonth()+1,
year:d.getFullYear()
});
localStorage.setItem('financeData',JSON.stringify(transactions));
desc.value=''; amount.value='';
renderTransactions();
}

function renderTransactions(){
transactionList.innerHTML='';
let inc=0,exp=0;
transactions.forEach(t=>{
transactionList.innerHTML+=`
<tr>
<td>${t.type==='income'?'دخل':'مصروف'}</td>
<td>${t.category}</td>
<td>${t.desc}</td>
<td>${t.amount}</td>
<td>${t.date}</td>
</tr>`;
t.type==='income'?inc+=t.amount:exp+=t.amount;
});
totalIncome.textContent=inc;
totalExpense.textContent=exp;
balance.textContent=inc-exp;
}

/* ===== إغلاق الشهر ===== */
function closeMonth(){
if(!confirm('هل تريد إغلاق الشهر وترحيل المصروفات؟')) return;
const now=new Date();
const m = now.getMonth()+1;
const y = now.getFullYear();

// إصلاح النوع: تحويل للقيم الرقمية
const expenses = transactions.filter(t => t.type==='expense' && Number(t.month)===m && Number(t.year)===y);
if(!expenses.length) return alert('لا توجد مصروفات لهذا الشهر');

archiveData.push({month:m,year:y,data:expenses});
transactions = transactions.filter(t => !(t.type==='expense' && Number(t.month)===m && Number(t.year)===y));

localStorage.setItem('financeData',JSON.stringify(transactions));
localStorage.setItem('archiveData',JSON.stringify(archiveData));
updateArchiveSelect();
renderTransactions();
alert('تم إغلاق الشهر وترحيل المصروفات بنجاح');
}

/* ===== الديون ===== */
function addDebt(){
if(!debtor.value || debtAmount.value<=0) return;
debtData.push({
debtor:debtor.value,
amount:+debtAmount.value,
type:debtType.value,
date:new Date().toLocaleDateString('ar-EG')
});
localStorage.setItem('debtData',JSON.stringify(debtData));
debtor.value=''; debtAmount.value='';
renderDebts();
}

function renderDebts(){
debtList.innerHTML='';
debtData.forEach(d=>{
debtList.innerHTML+=`
<tr>
<td>${d.debtor}</td>
<td>${d.amount}</td>
<td>${d.type==='owedToYou'?'مدين لك':'أنت مدين'}</td>
<td>${d.date}</td>
</tr>`;
});
}

/* ===== الأرشيف ===== */
function updateArchiveSelect(){
archiveSelect.innerHTML='<option value="">اختر شهر</option>';
archiveData.forEach((a,i)=>{
archiveSelect.innerHTML+=`<option value="${i}">${a.month}/${a.year}</option>`;
});
}

function renderArchive(){
archiveList.innerHTML='';
const i=archiveSelect.value;
if(i==='') return;
archiveData[i].data.forEach(t=>{
archiveList.innerHTML+=`
<tr>
<td>${t.category}</td>
<td>${t.desc}</td>
<td>${t.amount}</td>
<td>${t.date}</td>
</tr>`;
});
}

function clearArchive(){
if(!confirm('هل تريد حذف كل الأرشيف؟')) return;
archiveData=[];
localStorage.removeItem('archiveData');
updateArchiveSelect();
archiveList.innerHTML='';
}

/* ===== PDF عربي ===== */
async function loadFont(doc){
const r=await fetch('NotoNaskhArabic-Regular.ttf');
const b=await r.arrayBuffer();
const f=btoa(String.fromCharCode(...new Uint8Array(b)));
doc.addFileToVFS('arab.ttf',f);
doc.addFont('arab.ttf','arab','normal');
doc.setFont('arab');
}

async function exportFinancePDF(){
const {jsPDF}=window.jspdf;
const doc=new jsPDF();
await loadFont(doc);
doc.text('كشف العمليات الحالية',200,15,{align:'right'});
doc.autoTable({
startY:25,
head:[['التاريخ','النوع','الفئة','الوصف','المبلغ']],
body:transactions.map(t=>[t.date,t.type==='income'?'دخل':'مصروف',t.category,t.desc,t.amount]),
styles:{font:'arab',halign:'right'}
});
doc.save('العمليات_الحالية.pdf');
}

async function exportDebtPDF(){
const {jsPDF}=window.jspdf;
const doc=new jsPDF();
await loadFont(doc);
doc.text('كشف الديون',200,15,{align:'right'});
doc.autoTable({
startY:25,
head:[['التاريخ','الاسم','النوع','المبلغ']],
body:debtData.map(d=>[d.date,d.debtor,d.type==='owedToYou'?'مدين لك':'أنت مدين',d.amount]),
styles:{font:'arab',halign:'right'}
});
doc.save('الديون.pdf');
}

async function exportArchivePDF(){
const i=archiveSelect.value;
if(i==='') return;
const {jsPDF}=window.jspdf;
const doc=new jsPDF();
await loadFont(doc);
const a=archiveData[i];
doc.text(`مصروفات ${a.month}/${a.year}`,200,15,{align:'right'});
doc.autoTable({
startY:25,
head:[['التاريخ','الفئة','الوصف','المبلغ']],
body:a.data.map(t=>[t.date,t.category,t.desc,t.amount]),
styles:{font:'arab',halign:'right'}
});
doc.save(`ارشيف_${a.month}_${a.year}.pdf`);
}

/* ===== تحميل عند التشغيل ===== */
renderTransactions();
renderDebts();
updateArchiveSelect();
</script>

</body>
</html>
